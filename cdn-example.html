<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MyEditor CDN Example</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }

    h1 {
      color: #1f2937;
      margin-bottom: 8px;
      font-size: 2rem;
    }

    .subtitle {
      color: #6b7280;
      margin-bottom: 30px;
      font-size: 1.1rem;
    }

    .editor-wrapper {
      margin: 25px 0;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      min-height: 400px;
    }

    .myeditor-root {
      min-height: 350px;
    }

    .myeditor-root .ProseMirror {
      outline: none;
      min-height: 350px;
      padding: 20px;
      cursor: text;
    }

    .myeditor-root .ProseMirror:focus {
      outline: none;
      border: none;
    }

    .controls {
      margin: 20px 0;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }

    button:hover {
      background: #2563eb;
    }

    .usage-info {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-top: 25px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 14px;
      border: 1px solid #e9ecef;
    }

    .output {
      margin-top: 20px;
      padding: 20px;
      background: #1f2937;
      color: #f3f4f6;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }

    .success {
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 500;
    }
  </style>

  <script>
    // Global variables
    window.editorInstance = null;
    window.realTimeJSONEnabled = false;

    // Smart environment detection
    function detectEnvironment() {
      const isLocal =
        window.location.hostname === 'localhost' ||
        window.location.hostname === '127.0.0.1';
      const port = window.location.port;

      if (isLocal && (port === '5173' || port === '5174' || port === '5175' || port === '3000')) {
        return 'development'; // npm run dev
      } else if (isLocal && (port === '8080' || port === '8081')) {
        return 'local-production'; // npm run serve
      } else {
        return 'production'; // live server
      }
    }

    function getAssetPaths() {
      const env = detectEnvironment();

      switch (env) {
        case 'development':
          return {
            css: '/src/styles/myeditor.css',
            js: '/src/index.ts',
            label: 'üîß Development Mode (npm run dev)',
            isDev: true
          };

        case 'local-production':
          return {
            css: './myeditor.css',
            js: './myeditor.cdn.js',
            label: 'üß™ Local Production Test (npm run serve)',
            isDev: false
          };

        default:
          return {
            css: 'https://editor.explorepedia.org/myeditor.css',
            js: 'https://editor.explorepedia.org/myeditor.cdn.js',
            label: 'üöÄ Live Production',
            isDev: false
          };
      }
    }

    const paths = getAssetPaths();
    console.log(paths.label);
    console.log('üìÅ CSS:', paths.css);
    console.log('üìÅ JS:', paths.js);

    // Load CSS
    const cssLink = document.createElement('link');
    cssLink.rel = 'stylesheet';
    cssLink.href = paths.css;
    cssLink.onload = () => console.log('‚úÖ CSS loaded');
    cssLink.onerror = () => console.error('‚ùå CSS failed to load');
    document.head.appendChild(cssLink);

    // Store paths for later use
    window.myEditorPaths = paths;
  </script>

  <script>
    // Load MyEditor JavaScript
    if (window.myEditorPaths.isDev) {
      // Dev mode - load ES module
      const script = document.createElement('script');
      script.type = 'module';
      script.innerHTML = `
        try {
          const module = await import('/src/index.ts');
          window.MyEditor = {
            createEditor: module.createEditor,
            DEFAULT_TOOLS: module.DEFAULT_TOOLS
          };
          console.log('‚úÖ MyEditor ES modules loaded');

          setTimeout(() => {
            initializeMyEditor();
          }, 100);
        } catch (error) {
          console.error('‚ùå Failed to load ES module:', error);

          const fallbackScript = document.createElement('script');
          fallbackScript.src = '/dist/myeditor.cdn.js';
          fallbackScript.onload = function() {
            console.log('‚úÖ Fallback script loaded');
            setTimeout(() => {
              initializeMyEditor();
            }, 100);
          };
          fallbackScript.onerror = function() {
            console.error('‚ùå Fallback script also failed');
            const out = document.getElementById('output');
            out.textContent = 'Failed to load MyEditor in development mode';
            out.style.display = 'block';
          };
          document.head.appendChild(fallbackScript);
        }
      `;
      document.head.appendChild(script);
    } else {
      // Production mode - use CDN script
      const script = document.createElement('script');
      script.src = window.myEditorPaths.js;

      script.onload = function () {
        console.log('‚úÖ MyEditor script loaded');
        setTimeout(() => {
          initializeMyEditor();
        }, 100);
      };

      script.onerror = function () {
        console.error('‚ùå Failed to load MyEditor script');
      };

      document.head.appendChild(script);
    }

    // ‚úÖ IMPORTANT: We DO NOT call mountToolbar here anymore.
    // Because createEditor.ts now auto-mounts toolbar internally.

    function initializeMyEditor() {
      console.log('üöÄ Initializing MyEditor...');

      if (typeof window.MyEditor === 'undefined' || !window.MyEditor.createEditor) {
        console.error('‚ùå MyEditor not found!');
        const output = document.getElementById('output');
        if (output) {
          output.style.display = 'block';
          output.textContent = '‚ùå MyEditor script not loaded. Check the console for errors.';
        }
        return;
      }

      if (window.editorInstance) {
        console.log('‚ö†Ô∏è Already initialized');
        return;
      }

      const container = document.getElementById('myeditor-container');
      if (!container) {
        console.error('‚ùå Container element not found!');
        return;
      }

      try {
        // ‚úÖ Only createEditor
        window.editorInstance = window.MyEditor.createEditor(container, {
          placeholder: '‚ú® Click here and start typing...'
        });

        const statusEl = document.getElementById('status');
        if (statusEl) statusEl.style.display = 'block';

        console.log('‚úÖ MyEditor initialized successfully!');
      } catch (error) {
        console.error('‚ùå Error initializing MyEditor:', error);
        const output = document.getElementById('output');
        if (output) {
          output.style.display = 'block';
          output.textContent = '‚ùå Error: ' + (error && error.message ? error.message : String(error));
        }
      }
    }
  </script>
</head>

<body>
  <div class="container">
    <h1>üöÄ MyEditor CDN Example</h1>
    <p class="subtitle">
      ‡§Ø‡§π example ‡§¶‡§ø‡§ñ‡§æ‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§Ü‡§™ ‡§Ö‡§™‡§®‡•á MyEditor ‡§ï‡•ã CDN ‡§ï‡•Ä ‡§§‡§∞‡§π ‡§ï‡•à‡§∏‡•á use ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§
    </p>

    <div id="status" class="success" style="display: none;">
      ‚úÖ MyEditor successfully initialized!
    </div>

    <!-- Editor Container -->
    <div class="editor-wrapper">
      <div id="myeditor-container"></div>
    </div>

    <div class="controls">
      <button onclick="getContent()">üìÑ Get Content</button>
      <button onclick="setContent()">üìù Set Sample Content</button>
      <button onclick="clearEditor()">üóëÔ∏è Clear Editor</button>
      <button onclick="toggleOutput()">üëÅÔ∏è Toggle Output</button>
      <button onclick="showJSON()">üîß Show JSON Structure</button>
      <button onclick="toggleRealTimeJSON(event)">‚ö° Real-time JSON</button>
    </div>

    <div class="usage-info">
      <strong>üí° CDN Usage:</strong><br />
      &lt;link rel="stylesheet" href="https://editor.explorepedia.org/myeditor.css"&gt;<br />
      &lt;script src="https://editor.explorepedia.org/myeditor.cdn.js"&gt;&lt;/script&gt;<br /><br />
      <strong>üîß Initialize:</strong><br />
      const editor = MyEditor.createEditor(container, { placeholder: "Start typing..." });<br />
      <!-- toolbar auto-mounts inside createEditor -->
    </div>

    <div id="output" class="output"></div>

    <!-- JSON Viewer -->
    <div id="json-viewer" class="output" style="background: #0f172a; border: 2px solid #1e293b;">
      <div style="background: #1e293b; padding: 10px; color: #f1f5f9; font-weight: bold; border-bottom: 1px solid #334155;">
        üìã JSON Document Structure
      </div>
      <pre id="json-content" style="margin: 0; padding: 20px; color: #e2e8f0;">Click "Show JSON Structure" to see the document JSON</pre>
    </div>
  </div>

  <script>
    function getContent() {
      if (!window.editorInstance) {
        alert('‚ùå Editor not initialized');
        return;
      }
      const content = window.editorInstance.getContent();
      const output = document.getElementById('output');
      output.style.display = 'block';
      output.textContent = 'üìÑ Current Editor Content:\n\n' + JSON.stringify(content, null, 2);
    }

    function setContent() {
      if (!window.editorInstance) {
        alert('‚ùå Editor not initialized');
        return;
      }

      const sampleContent = {
        schemaVersion: 1,
        doc: {
          type: "doc",
          content: [
            {
              type: "heading",
              attrs: { level: 1 },
              content: [{ type: "text", text: "üéØ Sample Content Loaded!" }]
            },
            {
              type: "paragraph",
              content: [
                { type: "text", text: "This content was set " },
                { type: "text", marks: [{ type: "strong" }], text: "programmatically" },
                { type: "text", text: " via the CDN API! " },
                { type: "text", marks: [{ type: "em" }], text: "Pretty cool, right? üòé" }
              ]
            },
            {
              type: "paragraph",
              content: [
                { type: "text", text: "Current time: " },
                { type: "text", marks: [{ type: "strong" }], text: new Date().toLocaleString() }
              ]
            }
          ]
        }
      };

      window.editorInstance.setContent(sampleContent);

      const output = document.getElementById('output');
      output.style.display = 'block';
      output.textContent = '‚úÖ Sample content loaded successfully!';
    }

    function clearEditor() {
      if (!window.editorInstance) {
        alert('‚ùå Editor not initialized');
        return;
      }

      const emptyContent = {
        schemaVersion: 1,
        doc: { type: "doc", content: [] }
      };

      window.editorInstance.setContent(emptyContent);

      const output = document.getElementById('output');
      output.style.display = 'block';
      output.textContent = 'üóëÔ∏è Editor cleared successfully!';
    }

    function toggleOutput() {
      const output = document.getElementById('output');
      if (output.style.display === 'none' || output.style.display === '') {
        output.style.display = 'block';
        if (!output.textContent.trim()) {
          output.textContent = 'üëã Output panel opened! Use the buttons above to see results here.';
        }
      } else {
        output.style.display = 'none';
      }
    }

    function showJSON() {
      if (!window.editorInstance) {
        alert('‚ùå Editor not initialized');
        return;
      }

      const content = window.editorInstance.getContent();
      const jsonViewer = document.getElementById('json-viewer');
      const jsonContent = document.getElementById('json-content');

      jsonViewer.style.display = 'block';
      jsonContent.textContent = JSON.stringify(content, null, 2);
      highlightJSON(jsonContent);
    }

    function toggleRealTimeJSON(ev) {
      window.realTimeJSONEnabled = !window.realTimeJSONEnabled;

      const button = ev && ev.target ? ev.target : null;

      if (window.realTimeJSONEnabled) {
        if (button) {
          button.textContent = '‚èπÔ∏è Stop Real-time';
          button.style.background = '#ef4444';
        }
        showJSON();
        setupRealTimeJSON();
      } else {
        if (button) {
          button.textContent = '‚ö° Real-time JSON';
          button.style.background = '#3b82f6';
        }
        const jsonViewer = document.getElementById('json-viewer');
        jsonViewer.style.display = 'none';
      }
    }

    function setupRealTimeJSON() {
      if (!window.editorInstance || !window.editorInstance.view) return;

      const dom = window.editorInstance.view.dom;

      // Avoid multiple listeners
      if (dom.__myeditorRealtimeBound) return;
      dom.__myeditorRealtimeBound = true;

      dom.addEventListener('input', () => {
        if (!window.realTimeJSONEnabled) return;
        setTimeout(() => {
          try {
            const content = window.editorInstance.getContent();
            const jsonContent = document.getElementById('json-content');
            const viewer = document.getElementById('json-viewer');
            if (jsonContent && viewer && viewer.style.display !== 'none') {
              jsonContent.textContent = JSON.stringify(content, null, 2);
              highlightJSON(jsonContent);
            }
          } catch (e) {}
        }, 100);
      });
    }

    function highlightJSON(element) {
      let html = element.textContent;

      html = html.replace(/"([^"]+)":/g, '<span style="color: #60a5fa;">"$1"</span>:');
      html = html.replace(/: "([^"]+)"/g, ': <span style="color: #34d399;">"$1"</span>');
      html = html.replace(/: (\d+)/g, ': <span style="color: #fbbf24;">$1</span>');
      html = html.replace(/: (true|false|null)/g, ': <span style="color: #f87171;">$1</span>');
      html = html.replace(/(\[|\]|\{|\})/g, '<span style="color: #a78bfa;">$1</span>');

      element.innerHTML = html;
    }
  </script>
</body>
</html>
